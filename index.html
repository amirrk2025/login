<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لاگین مشتریان با SMS</title>
    <style>
        body { font-family: 'Tahoma', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .step { display: none; }
        .step.active { display: block; }
        ul { list-style: none; padding: 0; }
        li { padding: 5px; border-bottom: 1px solid #eee; }
        h2 { margin-top: 30px; }
        #resendCode { background: #007bff; }
        #resendCode:hover { background: #0056b3; }
    </style>
</head>
<body>
<div class="container">
    <h1>ورود مشتری</h1>
    
    <!-- قدم ۱: وارد کردن اسم و شماره -->
    <div id="step1" class="step active">
        <form id="registerForm">
            <input type="text" id="customerName" placeholder="نام مشتری" required>
            <input type="tel" id="customerNumber" placeholder="شماره مشتری (مثل ۰۹۱۲۳۴۵۶۷۸۹)" required>
            <button type="submit">ارسال کد تایید</button>
        </form>
    </div>

    <!-- قدم ۲: وارد کردن کد -->
    <div id="step2" class="step">
        <p>کد تایید به شماره <span id="phoneDisplay"></span> ارسال شد.</p>
        <form id="verifyForm">
            <input type="text" id="verifyCode" placeholder="کد ۴ رقمی را وارد کنید" required maxlength="4">
            <button type="submit">تایید کد</button>
        </form>
        <button id="resendCode">ارسال مجدد کد</button>
    </div>

    <!-- قدم ۳: لیست -->
    <div id="step3" class="step">
        <h2>با موفقیت ثبت شدید!</h2>
        <h2>لیست مشتریان ذخیره‌شده:</h2>
        <ul id="customerList"></ul>
    </div>

    <div id="message"></div>
</div>

<script>
    // تنظیمات SMS (API key رو امن نگه دار - در production از Vercel env استفاده کن، اما در JS عمومی می‌شه)
    const SMS_API_KEY = 'OWZmMGNmMmQtYzc4Zi00NDRhLWFmNWEtYTY4Zjk3ZjZlNmM5MGNhY2M4OTQwNmRmNjA1MWEwY2NjYzNhMDhlNzIwNGQ='; // هشدار: این عمومیه، regenerate کن!
    const SMS_PATTERN_CODE = 'kvndfu4hb67n1ix';
    const SMS_SENDER = '+983000505';
    const SMS_URL = 'https://api2.ippanel.com/api/v1/sms/pattern/normal/send';

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzvKM3N10Wok7cxKjviAufvDPTkKW4Q4qyENeHX1UN5afybqQY6YaDykZUcN63jbuM7/exec';

    let currentData = {}; // ذخیره موقت: {name, phone, code, timestamp}

    // قدم ۱: ارسال SMS
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('customerName').value;
        const phone = document.getElementById('customerNumber').value;
        if (!name || !phone) return showMessage('نام و شماره رو وارد کن!', 'error');

        // تولید کد
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        currentData = { name, phone, code, timestamp: Date.now() };

        // payload SMS
        const payload = {
            code: SMS_PATTERN_CODE,
            sender: SMS_SENDER,
            recipient: phone,
            variable: { verification_code: code }
        };

        try {
            const response = await fetch(SMS_URL, {
                method: 'POST',
                headers: { 'apikey': SMS_API_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.status !== 200) {
                throw new Error('خطا در ارسال SMS: ' + response.status);
            }

            showMessage('کد به شماره شما ارسال شد!', 'success');
            document.getElementById('phoneDisplay').textContent = phone;
            switchStep('step1', 'step2');
        } catch (error) {
            showMessage('خطا: ' + error.message, 'error');
        }
    });

    // قدم ۲: تایید کد
    document.getElementById('verifyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('verifyCode').value;
        if (!code) return;

        // چک کد (محلی)
        if (currentData.code !== code || (Date.now() - currentData.timestamp > 300000)) { // ۵ دقیقه expire
            showMessage('کد نامعتبر یا منقضی شده!', 'error');
            return;
        }

        // ذخیره در Sheets
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ name: currentData.name, number: currentData.phone })
            });
            if (!response.ok) throw new Error('خطا در ذخیره');

            showMessage('شماره تایید شد و ذخیره شد!', 'success');
            switchStep('step2', 'step3');
            loadCustomers();
            currentData = {}; // پاک کردن
        } catch (error) {
            showMessage('خطا: ' + error.message, 'error');
        }
    });

    // ارسال مجدد
    document.getElementById('resendCode').addEventListener('click', () => {
        document.getElementById('registerForm').dispatchEvent(new Event('submit'));
    });

    function switchStep(hide, show) {
        document.getElementById(hide).classList.remove('active');
        document.getElementById(show).classList.add('active');
    }

    function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = type;
    }

    // لود لیست (عین قبل)
    async function loadCustomers() {
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) throw new Error('خطا در لود');
            const data = await response.json();
            const customerList = document.getElementById('customerList');
            customerList.innerHTML = '';
            data.slice(1).forEach(row => {
                const li = document.createElement('li');
                li.textContent = `نام: ${row[1] || ''} | شماره: ${row[2] || ''}`;
                customerList.appendChild(li);
            });
        } catch (error) {
            showMessage('خطا در لود لیست: ' + error.message, 'error');
        }
    }

    loadCustomers(); // لود اولیه
</script>
</body>
</html>
