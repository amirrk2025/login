<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لاگین مشتریان با SMS</title>
    <style>
        body { font-family: 'Tahoma', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .step { display: none; }
        .step.active { display: block; }
        ul { list-style: none; padding: 0; }
        li { padding: 5px; border-bottom: 1px solid #eee; }
        h2 { margin-top: 30px; }
        #resendCode { background: #007bff; }
        #resendCode:hover { background: #0056b3; }
    </style>
</head>
<body>
<div class="container">
    <h1>ورود مشتری</h1>
    
    <!-- قدم ۱: وارد کردن اسم و شماره -->
    <div id="step1" class="step active">
        <form id="registerForm">
            <input type="text" id="customerName" placeholder="نام مشتری" required>
            <input type="tel" id="customerNumber" placeholder="شماره مشتری (مثل ۰۹۱۲۳۴۵۶۷۸۹)" required>
            <button type="submit">ارسال کد تایید</button>
        </form>
    </div>

    <!-- قدم ۲: وارد کردن کد -->
    <div id="step2" class="step">
        <p>کد تایید به شماره <span id="phoneDisplay"></span> ارسال شد.</p>
        <form id="verifyForm">
            <input type="text" id="verifyCode" placeholder="کد ۴ رقمی را وارد کنید" required maxlength="4">
            <button type="submit">تایید کد</button>
        </form>
        <button id="resendCode">ارسال مجدد کد</button>
    </div>

    <!-- قدم ۳: موفقیت موقت (حالا حذف شد، مستقیم به قدم ۱ برمی‌گرده) -->
    <div id="message"></div>
</div>

<script>
    // تنظیمات SMS (API key رو regenerate کن و امن نگه دار)
    const SMS_API_KEY = 'OWZmMGNmMmQtYzc4Zi00NDRhLWFmNWEtYTY4Zjk3ZjZlNmM5MGNhY2M4OTQwNmRmNjA1MWEwY2NjYzNhMDhlNzIwNGQ=';
    const SMS_PATTERN_CODE = 'kvndfu4hb67n1ix';
    const SMS_SENDER = '+983000505';
    const SMS_URL = 'https://api2.ippanel.com/api/v1/sms/pattern/normal/send';

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzvKM3N10Wok7cxKjviAufvDPTkKW4Q4qyENeHX1UN5afybqQY6YaDykZUcN63jbuM7/exec';

    let currentData = {}; // {name, phone, code, timestamp}

    // تابع ارسال SMS عمومی
    async function sendSMS(phone, variables, message = 'کد تایید') {
        const payload = {
            code: SMS_PATTERN_CODE,
            sender: SMS_SENDER,
            recipient: phone,
            variable: variables
        };

        try {
            const response = await fetch(SMS_URL, {
                method: 'POST',
                headers: { 'apikey': SMS_API_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.status !== 200) {
                throw new Error(message + ' ارسال نشد: ' + response.status);
            }
            return true;
        } catch (error) {
            throw new Error(message + ' خطا: ' + error.message);
        }
    }

    // قدم ۱: ارسال کد تایید
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerNumber').value.trim();
        if (!name || !phone) return showMessage('نام و شماره رو وارد کن!', 'error');

        // تولید کد
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        currentData = { name, phone, code, timestamp: Date.now() };

        try {
            await sendSMS(phone, { verification_code: code }, 'کد تایید');
            showMessage('کد به شماره شما ارسال شد!', 'success');
            document.getElementById('phoneDisplay').textContent = phone;
            switchStep('step1', 'step2');
            document.getElementById('verifyCode').focus();
        } catch (error) {
            showMessage(error.message, 'error');
        }
    });

    // قدم ۲: تایید کد
    document.getElementById('verifyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('verifyCode').value.trim();
        if (!code) return;

        // چک کد
        if (currentData.code !== code || (Date.now() - currentData.timestamp > 300000)) { // ۵ دقیقه
            showMessage('کد نامعتبر یا منقضی شده!', 'error');
            return;
        }

        try {
            // ذخیره در Sheets (اسم و شماره هر دو)
            const sheetResponse = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ name: currentData.name, number: currentData.phone })
            });
            if (!sheetResponse.ok) throw new Error('خطا در ذخیره اطلاعات');

            // ارسال SMS موفقیت
            await sendSMS(currentData.phone, { verification_code: 'با موفقیت!' }, 'پیام موفقیت');

            showMessage('شماره تایید شد و ذخیره شد! پیام موفقیت ارسال شد.', 'success');
            resetForm(); // برگشت به قدم ۱
        } catch (error) {
            showMessage('خطا: ' + error.message, 'error');
        }
    });

    // ارسال مجدد
    document.getElementById('resendCode').addEventListener('click', () => {
        const name = document.getElementById('customerName').value.trim();
        if (name) {
            document.getElementById('registerForm').dispatchEvent(new Event('submit'));
        } else {
            switchStep('step2', 'step1');
        }
    });

    // ریست فرم به قدم ۱
    function resetForm() {
        document.getElementById('registerForm').reset();
        document.getElementById('verifyForm').reset();
        currentData = {};
        switchStep('step2', 'step1');
        loadCustomers(); // آپدیت لیست
    }

    function switchStep(hide, show) {
        document.getElementById(hide).classList.remove('active');
        document.getElementById(show).classList.add('active');
    }

    function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = type;
        setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 5000); // پاک کردن بعد ۵ ثانیه
    }

    // لود لیست (عین قبل، بدون قدم ۳)
    async function loadCustomers() {
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) throw new Error('خطا در لود');
            const data = await response.json();
            // اگر می‌خوای لیست رو نشون بدی، یک div اضافه کن؛ فعلاً console.log
            console.log('مشتریان:', data.slice(1));
        } catch (error) {
            console.error('خطا در لود لیست:', error);
        }
    }

    loadCustomers(); // لود اولیه
</script>
</body>
</html>
